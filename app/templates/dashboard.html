{% extends "base.html" %}
{% block content %}

<h1 style="margin-bottom:25px;">Dashboard</h1>

<div class="cards-grid">

  <!-- Users -->
  <div class="stat-card blue">
    <svg class="icon" viewBox="0 0 24 24">
      <circle cx="12" cy="7" r="4"/>
      <path d="M5.5 21a6.5 6.5 0 0 1 13 0"/>
    </svg>
    <div>
      <p style="opacity:.7;margin:0;">Total Users</p>
      <h2 id="usersCount" class="counter">0</h2>
    </div>
  </div>

  <!-- Keys -->
  <div class="stat-card purple">
    <svg class="icon" viewBox="0 0 24 24">
      <circle cx="8" cy="12" r="3"/>
      <path d="M11 12h10l-2 2m2-2l-2-2"/>
    </svg>
    <div>
      <p style="opacity:.7;margin:0;">Total Keys</p>
      <h2 id="keysCount" class="counter">0</h2>
    </div>
  </div>

  <!-- Devices -->
  <div class="stat-card green">
    <svg class="icon" viewBox="0 0 24 24">
      <rect x="2" y="4" width="20" height="14" rx="2"/>
      <path d="M8 22h8"/>
    </svg>
    <div>
      <p style="opacity:.7;margin:0;">Active Devices</p>
      <h2 id="devicesCount" class="counter">0</h2>
    </div>
  </div>

</div>

<script>
// ===== Animated Counter =====
function animate(el, target) {
    let current = parseInt(el.innerText) || 0;
    const step = Math.ceil((target - current) / 15);

    if (current < target) {
        el.innerText = current + step;
    } else if (current > target) {
        el.innerText = current - step;
    } else {
        el.innerText = target;
    }
}

// ===== SSE Live Updates =====
const source = new EventSource("/live-stats");

source.onmessage = function(event) {
    const data = JSON.parse(event.data);

    animate(document.getElementById("usersCount"), data.users);
    animate(document.getElementById("keysCount"), data.keys);
    animate(document.getElementById("devicesCount"), data.active);
};

// لو الاتصال وقع
source.onerror = function() {
    console.warn("Live connection lost, retrying...");
};
</script>

{% endblock %}
